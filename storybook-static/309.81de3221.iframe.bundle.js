"use strict";(self.webpackChunkhbc_project_controls=self.webpackChunkhbc_project_controls||[]).push([[309],{"./src/webparts/hbcProjectControls/components/contexts/SignalRContext.tsx"(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{$:()=>useSignalRContext});__webpack_require__("./node_modules/react/jsx-runtime.js");var react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/react/index.js");__webpack_require__("./src/webparts/hbcProjectControls/components/contexts/AppContext.tsx"),__webpack_require__("./packages/hbc-sp-services/src/index.ts");const SignalRContext=react__WEBPACK_IMPORTED_MODULE_1__.createContext({connectionStatus:"disconnected",isEnabled:!1,subscribe:()=>()=>{},broadcastChange:()=>{}}),useSignalRContext=()=>react__WEBPACK_IMPORTED_MODULE_1__.useContext(SignalRContext),SignalRProvider=({children})=>{const{isFeatureEnabled,selectedProject}=(void 0)(),isEnabled=isFeatureEnabled("RealTimeUpdates"),[connectionStatus,setConnectionStatus]=(void 0).useState((void 0).status),prevProjectRef=(void 0).useRef(null);(void 0).useEffect(()=>(void 0).onStatusChange(setConnectionStatus),[]),(void 0).useEffect(()=>{isEnabled?(void 0).connect():(void 0).disconnect()},[isEnabled]),(void 0).useEffect(()=>{if(!isEnabled||"connected"!==connectionStatus)return;const prevCode=prevProjectRef.current,newCode=(null==selectedProject?void 0:selectedProject.projectCode)||null;prevCode!==newCode&&(prevCode&&(void 0).leaveGroup(`project:${prevCode.toLowerCase()}`),newCode&&(void 0).joinGroup(`project:${newCode.toLowerCase()}`),prevProjectRef.current=newCode)},[isEnabled,connectionStatus,selectedProject]),(void 0).useEffect(()=>{if(!isEnabled)return;return(void 0).subscribe("EntityChanged",msg=>{if("EntityChanged"!==msg.type)return;const entityMsg=msg;(function entityTypeToCacheKeys(entityType,projectCode){const keys=[],baseKeys={[(void 0).Lead]:[(void 0).LEADS],[(void 0).Scorecard]:[(void 0).SCORECARDS],[(void 0).Estimate]:[(void 0).ESTIMATES,(void 0).KICKOFFS],[(void 0).Project]:[(void 0).PROJECTS,(void 0).ACTIVE_PROJECTS,(void 0).PORTFOLIO_SUMMARY,(void 0).PERSONNEL_WORKLOAD,(void 0).DATA_MART],[(void 0).Meeting]:[(void 0).MEETINGS],[(void 0).ProjectRecord]:[(void 0).MARKETING_RECORDS],[(void 0).Permission]:[(void 0).PERMISSIONS],[(void 0).PermissionTemplate]:[(void 0).TEMPLATES],[(void 0).ProjectTeamAssignment]:[(void 0).PERMISSIONS,(void 0).ASSIGNMENTS,(void 0).ACCESSIBLE_PROJECTS],[(void 0).Config]:[(void 0).CONFIG,(void 0).FEATURE_FLAGS,(void 0).SECTORS],[(void 0).WorkflowDefinition]:[(void 0).WORKFLOWS],[(void 0).AssignmentMapping]:[(void 0).ASSIGNMENTS],[(void 0).Quality]:[(void 0).QUALITY],[(void 0).Safety]:[(void 0).SAFETY],[(void 0).RiskCost]:[(void 0).RISK_COST,(void 0).BUYOUT],[(void 0).Schedule]:[(void 0).SCHEDULE],[(void 0).SuperintendentPlan]:[(void 0).SUPER_PLAN],[(void 0).LessonLearned]:[(void 0).LESSONS],[(void 0).PMP]:[(void 0).PMP],[(void 0).MonthlyReview]:[(void 0).MONTHLY_REVIEW],[(void 0).Checklist]:[(void 0).CHECKLIST],[(void 0).Matrix]:[(void 0).MATRIX],[(void 0).TurnoverAgenda]:[(void 0).TURNOVER]}[entityType];return baseKeys&&(keys.push(...baseKeys),projectCode&&baseKeys.forEach(k=>keys.push(`${k}_${projectCode}`))),keys})(entityMsg.entityType,entityMsg.projectCode).forEach(key=>(void 0).removeByPrefix(key))})},[isEnabled]);const subscribe=(void 0).useCallback((channelKey,callback)=>(void 0).subscribe(channelKey,callback),[]),broadcastChange=(void 0).useCallback(message=>{(void 0).broadcastChange(message).catch(console.warn)},[]),value=(void 0).useMemo(()=>({connectionStatus,isEnabled,subscribe,broadcastChange}),[connectionStatus,isEnabled,subscribe,broadcastChange]);return(void 0)(SignalRContext.Provider,{value,children})};try{SignalRProvider.displayName="SignalRProvider",SignalRProvider.__docgenInfo={description:"",displayName:"SignalRProvider",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/webparts/hbcProjectControls/components/contexts/SignalRContext.tsx#SignalRProvider"]={docgenInfo:SignalRProvider.__docgenInfo,name:"SignalRProvider",path:"src/webparts/hbcProjectControls/components/contexts/SignalRContext.tsx#SignalRProvider"})}catch(__react_docgen_typescript_loader_error){}},"./src/webparts/hbcProjectControls/components/hooks/useLeads.ts"(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{D:()=>useLeads});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),_tanstack_react_query__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js"),_contexts_AppContext__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./src/webparts/hbcProjectControls/components/contexts/AppContext.tsx"),_contexts_SignalRContext__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/webparts/hbcProjectControls/components/contexts/SignalRContext.tsx"),_useSignalR__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./src/webparts/hbcProjectControls/components/hooks/useSignalR.ts"),_hbc_sp_services__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./packages/hbc-sp-services/src/index.ts"),_tanstack_query_mutations_useHbcOptimisticMutation__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./src/webparts/hbcProjectControls/tanstack/query/mutations/useHbcOptimisticMutation.ts"),_tanstack_query_mutations_optimisticMutationFlags__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./src/webparts/hbcProjectControls/tanstack/query/mutations/optimisticMutationFlags.ts");function useLeads(){const{dataService,currentUser}=(0,_contexts_AppContext__WEBPACK_IMPORTED_MODULE_2__.Us)(),{broadcastChange}=(0,_contexts_SignalRContext__WEBPACK_IMPORTED_MODULE_3__.$)(),queryClient=(0,_tanstack_react_query__WEBPACK_IMPORTED_MODULE_1__.jE)(),[leads,setLeads]=react__WEBPACK_IMPORTED_MODULE_0__.useState([]),[totalCount,setTotalCount]=react__WEBPACK_IMPORTED_MODULE_0__.useState(0),[isLoading,setIsLoading]=react__WEBPACK_IMPORTED_MODULE_0__.useState(!1),[error,setError]=react__WEBPACK_IMPORTED_MODULE_0__.useState(null),leadsCacheKey=react__WEBPACK_IMPORTED_MODULE_0__.useMemo(()=>["local","leads"],[]),fetchLeads=react__WEBPACK_IMPORTED_MODULE_0__.useCallback(async options=>{try{setIsLoading(!0),setError(null);const result=await dataService.getLeads(options);setLeads(result.items),setTotalCount(result.totalCount),queryClient.setQueryData(leadsCacheKey,result.items)}catch(err){setError(err instanceof Error?err.message:"Failed to fetch leads")}finally{setIsLoading(!1)}},[dataService,leadsCacheKey,queryClient]);(0,_useSignalR__WEBPACK_IMPORTED_MODULE_4__.k)({entityType:_hbc_sp_services__WEBPACK_IMPORTED_MODULE_5__.ckT.Lead,onEntityChanged:react__WEBPACK_IMPORTED_MODULE_0__.useCallback(()=>{fetchLeads()},[fetchLeads])});const broadcastLeadChange=react__WEBPACK_IMPORTED_MODULE_0__.useCallback((leadId,action,summary)=>{var _a;broadcastChange({type:"EntityChanged",entityType:_hbc_sp_services__WEBPACK_IMPORTED_MODULE_5__.ckT.Lead,entityId:String(leadId),action,changedBy:null!==(_a=null==currentUser?void 0:currentUser.email)&&void 0!==_a?_a:"unknown",changedByName:null==currentUser?void 0:currentUser.displayName,timestamp:(new Date).toISOString(),summary})},[broadcastChange,currentUser]),fetchLeadsByStage=react__WEBPACK_IMPORTED_MODULE_0__.useCallback(async stage=>{try{setIsLoading(!0),setError(null);const items=await dataService.getLeadsByStage(stage);setLeads(items),setTotalCount(items.length),queryClient.setQueryData(leadsCacheKey,items)}catch(err){setError(err instanceof Error?err.message:"Failed to fetch leads")}finally{setIsLoading(!1)}},[dataService,leadsCacheKey,queryClient]),createLeadMutation=(0,_tanstack_query_mutations_useHbcOptimisticMutation__WEBPACK_IMPORTED_MODULE_6__.h)({method:"createLead",domainFlag:_tanstack_query_mutations_optimisticMutationFlags__WEBPACK_IMPORTED_MODULE_7__.G.leads,mutationFn:async data=>dataService.createLead(data),getStateKey:()=>leadsCacheKey,applyOptimistic:(previous,data)=>{var _a;return[Object.assign(Object.assign({},data),{id:-Date.now(),Title:data.Title,ClientName:data.ClientName,Region:data.Region,Sector:data.Sector,Division:data.Division,Stage:data.Stage,Originator:null!==(_a=null==currentUser?void 0:currentUser.displayName)&&void 0!==_a?_a:"Pending",DateOfEvaluation:(new Date).toISOString()}),...null!=previous?previous:[]]},onOptimisticStateChange:state=>{const next=null!=state?state:[];setLeads(next),setTotalCount(next.length)},onSuccessEffects:async lead=>{setLeads(prev=>[lead,...prev.filter(item=>item.id>0)]),setTotalCount(prev=>prev+1),broadcastLeadChange(lead.id,"created","Lead created")},onSettledEffects:async()=>{await queryClient.invalidateQueries({queryKey:leadsCacheKey})}}),updateLeadMutation=(0,_tanstack_query_mutations_useHbcOptimisticMutation__WEBPACK_IMPORTED_MODULE_6__.h)({method:"updateLead",domainFlag:_tanstack_query_mutations_optimisticMutationFlags__WEBPACK_IMPORTED_MODULE_7__.G.leads,mutationFn:async({id,data})=>dataService.updateLead(id,data),getStateKey:()=>leadsCacheKey,applyOptimistic:(previous,vars)=>(null!=previous?previous:[]).map(lead=>lead.id===vars.id?Object.assign(Object.assign({},lead),vars.data):lead),onOptimisticStateChange:state=>setLeads(null!=state?state:[]),onSuccessEffects:async(updated,vars)=>{setLeads(prev=>prev.map(lead=>lead.id===vars.id?updated:lead)),broadcastLeadChange(vars.id,"updated","Lead updated")},onSettledEffects:async()=>{await queryClient.invalidateQueries({queryKey:leadsCacheKey})}}),deleteLeadMutation=(0,_tanstack_query_mutations_useHbcOptimisticMutation__WEBPACK_IMPORTED_MODULE_6__.h)({method:"deleteLead",domainFlag:_tanstack_query_mutations_optimisticMutationFlags__WEBPACK_IMPORTED_MODULE_7__.G.leads,mutationFn:async id=>dataService.deleteLead(id),getStateKey:()=>leadsCacheKey,applyOptimistic:(previous,id)=>(null!=previous?previous:[]).filter(lead=>lead.id!==id),onOptimisticStateChange:state=>{const next=null!=state?state:[];setLeads(next),setTotalCount(next.length)},onSuccessEffects:async(_result,id)=>{setLeads(prev=>prev.filter(lead=>lead.id!==id)),setTotalCount(prev=>Math.max(0,prev-1)),broadcastLeadChange(id,"deleted","Lead deleted")},onSettledEffects:async()=>{await queryClient.invalidateQueries({queryKey:leadsCacheKey})}}),createLead=react__WEBPACK_IMPORTED_MODULE_0__.useCallback(async data=>createLeadMutation.mutateAsync(data),[createLeadMutation]),updateLead=react__WEBPACK_IMPORTED_MODULE_0__.useCallback(async(id,data)=>updateLeadMutation.mutateAsync({id,data}),[updateLeadMutation]),deleteLead=react__WEBPACK_IMPORTED_MODULE_0__.useCallback(async id=>{await deleteLeadMutation.mutateAsync(id)},[deleteLeadMutation]),searchLeads=react__WEBPACK_IMPORTED_MODULE_0__.useCallback(async query=>{try{setIsLoading(!0),setError(null);const items=await dataService.searchLeads(query);setLeads(items),setTotalCount(items.length),queryClient.setQueryData(leadsCacheKey,items)}catch(err){setError(err instanceof Error?err.message:"Search failed")}finally{setIsLoading(!1)}},[dataService,leadsCacheKey,queryClient]),getLeadById=react__WEBPACK_IMPORTED_MODULE_0__.useCallback(async id=>dataService.getLeadById(id),[dataService]);return{leads,totalCount,isLoading,error,fetchLeads,fetchLeadsByStage,createLead,updateLead,deleteLead,searchLeads,getLeadById}}},"./src/webparts/hbcProjectControls/components/hooks/useSignalR.ts"(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{k:()=>useSignalR});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),_contexts_SignalRContext__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/webparts/hbcProjectControls/components/contexts/SignalRContext.tsx");function useSignalR(options={}){const{connectionStatus,isEnabled,subscribe}=(0,_contexts_SignalRContext__WEBPACK_IMPORTED_MODULE_1__.$)(),{entityType,projectCode,onEntityChanged,onWorkflowAdvanced}=options,onEntityChangedRef=react__WEBPACK_IMPORTED_MODULE_0__.useRef(onEntityChanged),onWorkflowAdvancedRef=react__WEBPACK_IMPORTED_MODULE_0__.useRef(onWorkflowAdvanced);return onEntityChangedRef.current=onEntityChanged,onWorkflowAdvancedRef.current=onWorkflowAdvanced,react__WEBPACK_IMPORTED_MODULE_0__.useEffect(()=>{if(!isEnabled||!onEntityChangedRef.current)return;return subscribe("EntityChanged",msg=>{var _a;if("EntityChanged"!==msg.type)return;const entityMsg=msg;entityType&&entityMsg.entityType!==entityType||projectCode&&entityMsg.projectCode!==projectCode||null===(_a=onEntityChangedRef.current)||void 0===_a||_a.call(onEntityChangedRef,entityMsg)})},[isEnabled,subscribe,entityType,projectCode]),react__WEBPACK_IMPORTED_MODULE_0__.useEffect(()=>{if(!isEnabled||!onWorkflowAdvancedRef.current)return;return subscribe("WorkflowAdvanced",msg=>{var _a;if("WorkflowAdvanced"!==msg.type)return;const wfMsg=msg;entityType&&wfMsg.entityType!==entityType||projectCode&&wfMsg.projectCode!==projectCode||null===(_a=onWorkflowAdvancedRef.current)||void 0===_a||_a.call(onWorkflowAdvancedRef,wfMsg)})},[isEnabled,subscribe,entityType,projectCode]),{connectionStatus,isEnabled}}},"./src/webparts/hbcProjectControls/tanstack/query/mutations/optimisticMutationFlags.ts"(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{G:()=>OPTIMISTIC_MUTATION_FLAGS});const OPTIMISTIC_MUTATION_FLAGS={global:"OptimisticMutationsEnabled",leads:"OptimisticMutations_Leads",estimating:"OptimisticMutations_Estimating",buyout:"OptimisticMutations_Buyout",pmp:"OptimisticMutations_PMP"}},"./src/webparts/hbcProjectControls/tanstack/query/mutations/useHbcOptimisticMutation.ts"(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{h:()=>useHbcOptimisticMutation});var react=__webpack_require__("./node_modules/react/index.js"),QueryClientProvider=__webpack_require__("./node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js"),useMutation=__webpack_require__("./node_modules/@tanstack/react-query/build/modern/useMutation.js"),AppContext=__webpack_require__("./src/webparts/hbcProjectControls/components/contexts/AppContext.tsx"),optimisticMutationFlags=__webpack_require__("./src/webparts/hbcProjectControls/tanstack/query/mutations/optimisticMutationFlags.ts");var __rest=function(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(t[p[i]]=s[p[i]])}return t};const WAVE_A_METHODS=new Set(["createLead","updateLead","deleteLead","createEstimatingRecord","updateEstimatingRecord","addBuyoutEntry","updateBuyoutEntry","removeBuyoutEntry","updateProjectManagementPlan","submitPMPForApproval","respondToPMPApproval","signPMP"]);function useHbcOptimisticMutation(options){const queryClient=(0,QueryClientProvider.jE)(),{method,domainFlag,mutationFn,getStateKey,applyOptimistic,onOptimisticStateChange,onSuccess,onSettled,onError,onSuccessEffects,onSettledEffects}=options,rest=__rest(options,["method","domainFlag","mutationFn","getStateKey","applyOptimistic","onOptimisticStateChange","onSuccess","onSettled","onError","onSuccessEffects","onSettledEffects"]),optimisticEnabledByFlag=function useMutationFeatureGate(domainFlag){const{isFeatureEnabled}=(0,AppContext.Us)();return react.useMemo(()=>"function"==typeof isFeatureEnabled&&!!isFeatureEnabled(optimisticMutationFlags.G.global)&&isFeatureEnabled(domainFlag),[domainFlag,isFeatureEnabled])}(domainFlag),isMapped=react.useMemo(()=>WAVE_A_METHODS.has(method),[method]);return optimisticEnabledByFlag&&isMapped?(0,useMutation.n)(Object.assign(Object.assign({},rest),{mutationFn,onMutate:async variables=>{if(!getStateKey||!applyOptimistic)return{};const key=getStateKey(variables);await queryClient.cancelQueries({queryKey:key});const previousState=queryClient.getQueryData(key),optimisticState=applyOptimistic(previousState,variables);return queryClient.setQueryData(key,optimisticState),null==onOptimisticStateChange||onOptimisticStateChange(optimisticState),{previousState}},onError:async(error,variables,context,mutationContext)=>{getStateKey&&void 0!==(null==context?void 0:context.previousState)&&(queryClient.setQueryData(getStateKey(variables),context.previousState),null==onOptimisticStateChange||onOptimisticStateChange(context.previousState)),await(null==onError?void 0:onError(error,variables,context,mutationContext))},onSuccess:async(data,variables,context,mutationContext)=>{await(null==onSuccessEffects?void 0:onSuccessEffects(data,variables)),await(null==onSuccess?void 0:onSuccess(data,variables,context,mutationContext))},onSettled:async(data,error,variables,context,mutationContext)=>{await(null==onSettledEffects?void 0:onSettledEffects(variables)),await(null==onSettled?void 0:onSettled(data,error,variables,context,mutationContext))}})):(0,useMutation.n)(Object.assign(Object.assign({},rest),{mutationFn,onSuccess:async(data,variables,context,mutationContext)=>{await(null==onSuccessEffects?void 0:onSuccessEffects(data,variables)),await(null==onSuccess?void 0:onSuccess(data,variables,context,mutationContext))},onSettled:async(data,error,variables,context,mutationContext)=>{await(null==onSettledEffects?void 0:onSettledEffects(variables)),await(null==onSettled?void 0:onSettled(data,error,variables,context,mutationContext))},onError}))}}}]);